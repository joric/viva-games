<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Joric's Viva Games</title>
  <link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;," />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.3.1/dist/leaflet.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.3.1/dist/leaflet.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.0.0/src/L.Control.MousePosition.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.5/dist/leaflet-search.src.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.5/dist/leaflet-search.src.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/leaflet-edgebuffer@1.0.6/src/leaflet.edgebuffer.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.min.js"></script>

  <script src="tiles/names.js"></script>

  <style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map, .leaflet-control-minimap {
        height: 100%;
        width: 100%;
        background: black;
        image-rendering: pixelated;
        overflow: hidden;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 256;
      height: 192;
      //background-color: #fff;
      opacity: 0.5;
      outline: 2px solid white;
      color: grey;
      font-size: 12px;
      pointer-events: none;
      padding: 0;
      margin: 0;
      text-indent: 3px;
      z-index: 1000;
      visibility: hidden;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="overlay"></div>
<script>

let w = h = 32768;
let tileSize = 512;
let factor = tileSize / w;
let mapBounds = [[0,0], [h, w]];
let tw = 256;
let th = 192;
let cw = 128;
let ch = 132;
let minNativeZoom = 1;
let maxNativeZoom = 6;
let pw = 32768;
let ph = 25344;

L.CRS.myCRS = L.extend({}, L.CRS.Simple, {
  transformation: new L.Transformation(factor, 0, factor, 0),
});

let map = L.map('map', {
  crs: L.CRS.myCRS,
  fullscreenControl: true,
  fullscreenControlOptions: {
      position: 'topleft'
  },
}).setView([w/2,h/2],0);

L.TileLayer.MyCustomLayer = L.TileLayer.extend({
    getTileUrl: function(coords) {
      let ext = coords.z>=6 ? 'png' : 'jpg';
      return `tiles/${coords.z}/${coords.x}/${coords.y}.${ext}`;
    }
});

L.tileLayer.myCustomLayer = function(templateUrl, options) {
    return new L.TileLayer.MyCustomLayer(templateUrl, options);
}

L.tileLayer.myCustomLayer('', {
  minZoom: 0,
  minNativeZoom: minNativeZoom,
  maxNativeZoom: maxNativeZoom,
  tileSize: tileSize,
  bounds: mapBounds,
  attribution: '<a href="https://github.com/joric/viva-games" target="_blank">Joric\'s Viva Games</a>',
  edgeBufferTiles: 2,
}).addTo(map);

//map.setMaxBounds(mapBounds);  // elastic-y bounds
map.setMaxBounds([[-h/2,-w/2], [h+h/2, w+w/2]]); // add borders so corners could be in the center

//L.control.mousePosition({lngFirst: true}).addTo(map);

// mini map
var osm2 = L.tileLayer.myCustomLayer('', {
  minZoom: -2,
  minNativeZoom: minNativeZoom,
  maxNativeZoom: maxNativeZoom,
  tileSize: tileSize,
  bounds: mapBounds,
});

var miniMap = new L.Control.MiniMap(osm2, {
  toggleDisplay: true,
  width:128,
  height:100,
  //zoomLevelOffset: -7,
  zoomLevelFixed: -6,
  centerFixed: [h/2,w/2],
  aimingRectOptions: {color: "#ffffff", weight: 2, clickable: true, opacity: 1, fillOpacity: 0},
  shadowRectOptions: {color: "#000000", weight: 2, clickable: true, opacity: 0, fillOpacity: 0},
  position:'bottomleft',
}).addTo(map);

var n = names.length;
var data = new Array(n);
for (var i=0; i<n; i++) {
    let left = (w - pw)/2;
    let top = (h - ph)/2;
    let x = tw/2 + left + tw * (i % cw);
    let y = th/2 + top + th * Math.floor(i / cw);
    let title = names[i];
    data[i] = {"loc":[y,x], "title":title};
}

function localData(text, callResponse) {
    callResponse(data);
    return { abort: function() {} }
}

map.addControl(new L.Control.Search({
  sourceData: localData,
  autoType: true,
  text:'Text...',
  markerLocation: true,
  initial: false,
  hideMarkerOnCollapse: true,
  position: 'topright',
}));

map.on('mousemove', function(e) {
  //let t = getTileNumber(e.latlng.lng, e.latlng.lat);
  //document.getElementById('map').title = t>=0 ? 'game ' + t : '';
});

function getBoundingBox() {
  let left = (w - pw)/2;
  let top = (h - ph)/2;
  let right = left + pw;
  let bottom = top + ph;
  return [top,left,right,bottom];
}

function getTileNumber(latlng) {
  let [top,left,right,bottom] = getBoundingBox();
  let [y,x] = [latlng.lat, latlng.lng];
  if (x>=left && x<right && y>=top && y<bottom) {
    x -= left;
    y -= top;
    let tx = Math.floor(x / tw);
    let ty = Math.floor(y / th);
    return tx + Math.floor(pw / tw) * ty;
  }
  return -1;
}

function getTileBounds(tileNumber) {
  let [top,left,right,bottom] = getBoundingBox();
  let tx = tileNumber % cw;
  let ty = Math.floor(tileNumber / cw);
  let rx = left + tx * tw;
  let ry = top + ty * th;
  return [[ry, rx], [ry+th, rx+tw]];
}

var mousePos = {x:0, y:0};
window.addEventListener('mousemove', (event) => {
  mousePos = { x: event.clientX, y: event.clientY };
});

function updateOverlay() {
  return; // unused for now

  t = getTileNumber(map.containerPointToLatLng(L.point(mousePos.x, mousePos.y)));
  document.getElementById('map').title = t>=0 ? names[t] : '';

  c = document.getElementById('overlay');
  if (t<0) {
    c.style.visibility = 'hidden';
    return;
  }

  bounds = getTileBounds(t);

  var a = map.latLngToContainerPoint( L.latLng(bounds[0][0], bounds[0][1]) );
  var b = map.latLngToContainerPoint( L.latLng(bounds[1][0], bounds[1][1]) );

  c.style.left = a.x + 'px';
  c.style.top = a.y + 'px';
  c.style.width = (b.x-a.x) + 'px';
  c.style.height = (b.y-a.y) + 'px';
  c.style.visibility = 'visible';
}

map.on('mousemove', function(e) {
  updateOverlay();
});

map.on('dragstart', function(e) {
  history.replaceState(null, null, ' ');
});

map.on('zoomstart', function(e) {
  document.getElementById('overlay').style.visibility = 'hidden';
});

map.on('zoomend', function(e) {
  updateOverlay();
});

map.on('drag', function(e) {
  updateOverlay();
});

let current_tile = null;

function zoomToTile(tileNumber) {
  current_tile = tileNumber;
  bounds = getTileBounds(tileNumber);
  let extBounds = [[bounds[0][0]-8,bounds[0][1]],[bounds[1][0]+8,bounds[1][1]]];
  map.flyToBounds(extBounds, {duration: 0.3});
  let popup = L.popup();
  let point = L.latLng(bounds[0][0],(bounds[0][1]+bounds[1][1])/2)
  let id = names[tileNumber];
  popup.setLatLng(point).setContent('<a href="https://viva-games.ru/game/'+id+'" target=_blank>https://viva-games.ru/game/'+id+'</a>').openOn(map);
  window.location.hash = id;
}

map.on('click', function(e) {
  let t = getTileNumber(e.latlng);
  if (t<0) {
    return;
  }

  if (t==current_tile) {
    if (map.getZoom() > maxNativeZoom) {
      map.setZoom(maxNativeZoom);
      current_tile = null;
      history.replaceState(null, null, ' '); // remove window.location.hash
    }
  } else {
    zoomToTile(t);
  }
});

window.onload = function(e) {
  if (location.hash.length<1) {
    return
  }
  let id = location.hash.slice(1);
  for (i=0; i<names.length; i++) {
    if (id==names[i]) {
      zoomToTile(i);
      break;
    }
  } 
};

</script>
</body>
</html>
