<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Joric's Viva Games</title>
  <link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;," />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.0.0/src/L.Control.MousePosition.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.5/dist/leaflet-search.src.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.5/dist/leaflet-search.src.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/leaflet-edgebuffer@1.0.6/src/leaflet.edgebuffer.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.css" integrity="sha512-qm+jY0iQ4Xf5RL79UB75REDLYD0jtvxxVZp2RVIW8sm8RNiHdeN43oksqUPrBIshJtQcVPrAL08ML2Db8fFZiA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js" integrity="sha512-WL3nAJlWFKoDShduxQRyY3wkBnQsINXdIfWIW48ZaPgYz1wYNnxIwFMMgigzSgjNBC2WWZ8Y8/sSyUU6abuF0g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="tiles/names.js"></script>

  <style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map, .leaflet-control-minimap {
        height: 100%;
        width: 100%;
        background: black;
        image-rendering: pixelated;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script>

let w = h = 32768;
let tileSize = 512;
let factor = tileSize / w;
let mapBounds = [[0,0], [h, w]];
let tw = 256;
let th = 192;
let cw = 128;
let ch = 132;
let minNativeZoom = 1;
let maxNativeZoom = 6;
let pw = 32768;
let ph = 25344;

L.CRS.myCRS = L.extend({}, L.CRS.Simple, {
  transformation: new L.Transformation(factor, 0, factor, 0),
});

let map = L.map('map', {
  crs: L.CRS.myCRS,
}).setView([w/2,h/2],0);

L.TileLayer.MyCustomLayer = L.TileLayer.extend({
    getTileUrl: function(coords) {
      let ext = coords.z>=6 ? 'png' : 'jpg';
      return `tiles/${coords.z}/${coords.x}/${coords.y}.${ext}`;
    }
});

L.tileLayer.myCustomLayer = function(templateUrl, options) {
    return new L.TileLayer.MyCustomLayer(templateUrl, options);
}

L.tileLayer.myCustomLayer('', {
  minZoom: 0,
  minNativeZoom: minNativeZoom,
  maxNativeZoom: maxNativeZoom,
  tileSize: tileSize,
  bounds: mapBounds,
  attribution: '<a href="https://github.com/joric/viva-games" target="_blank">Joric\'s Viva Games</a>',
  edgeBufferTiles: 2,
}).addTo(map);


var osm2 = L.tileLayer.myCustomLayer('', {
  minZoom: -1,
  minNativeZoom: minNativeZoom,
  maxNativeZoom: maxNativeZoom,
  tileSize: tileSize,
  bounds: mapBounds,
});

var miniMap = new L.Control.MiniMap(osm2, {
  maxZoom: 0,
  toggleDisplay: true,
  width:256,
  height:200,
  zoomLevelOffset: -7,
  centerFixed: [h/2,w/2],
}).addTo(map);

//map.setMaxBounds(mapBounds);

L.control.mousePosition({lngFirst: true}).addTo(map);

var n = names.length;
var data = new Array(n);
for (var i=0; i<n; i++) {
    let left = (w - pw)/2;
    let top = (h - ph)/2;
    let x = tw/2 + left + tw * (i % cw);
    let y = th/2 + top + th * Math.floor(i / cw);
    let title = names[i];
    data[i] = {"loc":[y,x], "title":title};
}

function localData(text, callResponse) {
    callResponse(data);
    return { abort: function() {} }
}

map.addControl(new L.Control.Search({
  sourceData: localData,
  autoType: true,
  text:'Text...',
  markerLocation: true,
  initial: false,
  hideMarkerOnCollapse: true,
}));

map.on('mousemove', function(e) {
  //let t = getTileNumber(e.latlng.lng, e.latlng.lat);
  //document.getElementById('map').title = t>=0 ? 'game ' + t : '';
});

let current_tile = null;

function getTile(x,y) {
  let left = (w - pw)/2;
  let top = (h - ph)/2;
  let right = left + pw;
  let bottom = top + ph;
  if (x>=left && x<right && y>=top && y<bottom) {
    x -= left;
    y -= top;
    let tx = Math.floor(x / tw);
    let ty = Math.floor(y / th);
    let t = tx + Math.floor(pw / tw) * ty;
    let rx = left + tx * tw;
    let ry = top + ty * th;
    let bounds = [[ry, rx], [ry+th, rx+tw]];
    return [t,bounds];
  }
  return [-1,[]];
}

map.on('mousemove', function(e) {
  [t,bounds] = getTile(e.latlng.lng, e.latlng.lat);
  document.getElementById('map').title = t>=0 ? names[t] : '';
});

map.on('dragstart', function(e) {
  history.replaceState(null, null, ' ');
});

map.on('click', function(e) {
  let [t,bounds] = getTile(e.latlng.lng, e.latlng.lat);

  if (t<0) {
    return;
  }

  id = names[t];
  window.location.hash = id;

  if (t==current_tile) {
    if (map.getZoom() > maxNativeZoom) {
      map.setZoom(maxNativeZoom);
      current_tile = null;
      history.replaceState(null, null, ' ');
    }
  } else {
    // zoom to tile
    map.flyToBounds(bounds, {duration: 0.3});
    current_tile = t;
  }

  let popup = L.popup();
  popup.setLatLng(e.latlng).setContent('<a href="https://viva-games.ru/game/'+id+'" target=_blank>https://viva-games.ru/game/'+id+'</a>').openOn(map);
});

</script>
</body>
</html>
